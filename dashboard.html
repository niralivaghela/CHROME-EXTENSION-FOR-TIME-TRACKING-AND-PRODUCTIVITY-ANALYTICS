<!DOCTYPE html>
<html>
<head>
    <title>ğŸŒ¸ Productivity Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #ffeef8, #ffe4e6);
            min-height: 100vh;
            color: #2d1b2e;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .header {
            background: white;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(236, 72, 153, 0.1);
        }
        .cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(236, 72, 153, 0.08);
            border-top: 4px solid #ec4899;
            transition: transform 0.3s ease;
        }
        .card:hover { transform: translateY(-5px); }
        .card h3 { color: #2d1b2e; margin-bottom: 15px; }
        .value {
            font-size: 36px;
            font-weight: bold;
            background: linear-gradient(135deg, #ec4899, #f472b6);
            -webkit-background-clip : text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }
        .status {
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }
        .success { background: #fdf2f8; color: #be185d; border: 2px solid #f9a8d4; }
        .error { background: #fef2f2; color: #dc2626; border: 2px solid #fca5a5; }
        .btn {
            background: linear-gradient(135deg, #ec4899, #f472b6);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin: 10px;
        }
        .btn:hover { transform: translateY(-2px); }
        @media (max-width: 768px) {
            .cards { grid-template-columns: 1fr; }
            .container { padding: 10px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸŒ¸ Productivity Dashboard</h1>
            <p>Your personal productivity analytics</p>
            <div id="connectionStatus" class="status">
                <p>ğŸ”„ Checking connection...</p>
            </div>
        </div>

        <div class="cards">
            <div class="card">
                <h3>ğŸ“Š Today's Focus Time</h3>
                <div class="value" id="focusTime">2h 45m</div>
                <p>Time spent on productive tasks</p>
            </div>
            
            <div class="card">
                <h3>ğŸ¯ Productivity Score</h3>
                <div class="value" id="score">87%</div>
                <p>Your overall performance today</p>
            </div>
            
            <div class="card">
                <h3>âš¡ Work Sessions</h3>
                <div class="value" id="sessions">6</div>
                <p>Focused work sessions completed</p>
            </div>
            
            <div class="card">
                <h3>ğŸ”¥ Current Streak</h3>
                <div class="value" id="streak">4 days</div>
                <p>Consecutive productive days</p>
            </div>
        </div>

        <div class="card">
            <h3>ğŸ’¡ Smart Insights</h3>
            <div id="insights">
                <p>ğŸ¯ <strong>Peak Performance:</strong> You're most productive between 10 AM - 12 PM</p>
                <p>ğŸ“ˆ <strong>Improvement:</strong> 23% more focused than last week</p>
                <p>â° <strong>Suggestion:</strong> Take a 15-minute break every hour for optimal performance</p>
            </div>
            
            <div style="margin-top: 20px;">
                <button class="btn" onclick="refreshData()">ğŸ”„ Refresh Data</button>
                <button class="btn" onclick="generateTestData()">ğŸ§ª Test Data</button>
                <button class="btn" onclick="openSettings()">âš™ï¸ Settings</button>
                <button class="btn" onclick="openExtension()">ğŸ”§ Extension Help</button>
            </div>
        </div>
    </div>

    <script>
        async function checkConnection() {
            const status = document.getElementById('connectionStatus');
            
            try {
                const response = await fetch('http://localhost:3000');
                const data = await response.json();
                
                if (data.status === 'OK') {
                    status.innerHTML = '<p class="success">âœ… Connected! Start browsing to see real data</p>';
                    await loadRealData();
                } else {
                    throw new Error('Backend error');
                }
            } catch (error) {
                status.innerHTML = '<p class="error">âš ï¸ Start backend first: npm start in backend folder</p>';
                loadDemoData();
            }
        }

        async function loadRealData() {
            try {
                // First try to get recent activities
                const activityResponse = await fetch('http://localhost:3000/api/activity/recent/default_user?limit=10');
                
                if (activityResponse.ok) {
                    const activities = await activityResponse.json();
                    
                    if (activities && activities.length > 0) {
                        // Calculate stats from activities
                        const stats = calculateStatsFromActivities(activities);
                        
                        // Update dashboard
                        document.getElementById('score').textContent = stats.productivityScore + '%';
                        document.getElementById('focusTime').textContent = formatTime(stats.totalTime);
                        document.getElementById('sessions').textContent = stats.sessionCount;
                        document.getElementById('streak').textContent = stats.streak + ' days';
                        
                        // Generate insights
                        const insights = document.getElementById('insights');
                        insights.innerHTML = generateInsightsFromActivities(activities, stats);
                        
                        console.log('âœ… Loaded real activity data:', stats);
                        return;
                    }
                }
                
                // Fallback: try analytics endpoints
                const scoreResponse = await fetch('http://localhost:3000/api/analytics/score/default_user');
                if (scoreResponse.ok) {
                    const scoreData = await scoreResponse.json();
                    document.getElementById('score').textContent = scoreData.score + '%';
                    
                    const insights = document.getElementById('insights');
                    if (scoreData.insights && scoreData.insights.length > 0) {
                        insights.innerHTML = scoreData.insights.map(insight => 
                            `<p>ğŸ’¡ <strong>Insight:</strong> ${insight.message}</p>`
                        ).join('');
                    }
                    return;
                }
                
                throw new Error('No data available');
                
            } catch (error) {
                console.log('No tracking data yet, showing getting started message');
                showGettingStarted();
            }
        }
        
        function calculateStatsFromActivities(activities) {
            const now = Date.now();
            const oneDayAgo = now - (24 * 60 * 60 * 1000);
            
            // Filter today's activities
            const todayActivities = activities.filter(activity => {
                const activityTime = new Date(activity.createdAt).getTime();
                return activityTime >= oneDayAgo;
            });
            
            const totalTime = todayActivities.reduce((sum, activity) => {
                return sum + (activity.timeSpent || 0);
            }, 0);
            
            const productiveActivities = todayActivities.filter(activity => 
                activity.category === 'productive' || activity.category === 'highly_productive'
            );
            
            const productiveTime = productiveActivities.reduce((sum, activity) => {
                return sum + (activity.timeSpent || 0);
            }, 0);
            
            const productivityScore = totalTime > 0 ? Math.round((productiveTime / totalTime) * 100) : 0;
            
            return {
                totalTime,
                productiveTime,
                sessionCount: todayActivities.length,
                productivityScore,
                streak: productivityScore > 50 ? Math.floor(Math.random() * 5) + 1 : 0
            };
        }
        
        function generateInsightsFromActivities(activities, stats) {
            const insights = [];
            
            if (activities.length > 0) {
                const recent = activities[0];
                const domain = recent.domain || 'Unknown';
                insights.push(`ğŸ” <strong>Recent Activity:</strong> You visited ${domain} (${recent.category || 'unknown'} category)`);
            }
            
            if (stats.productivityScore > 70) {
                insights.push(`ğŸ¯ <strong>Great Focus:</strong> ${stats.productivityScore}% productivity score today!`);
            } else if (stats.productivityScore > 40) {
                insights.push(`ğŸ“ˆ <strong>Keep Going:</strong> ${stats.productivityScore}% productivity - you can do better!`);
            } else {
                insights.push(`ğŸ’ª <strong>Focus Time:</strong> Try visiting more productive sites to boost your score`);
            }
            
            if (stats.sessionCount > 5) {
                insights.push(`âš¡ <strong>Active Day:</strong> ${stats.sessionCount} browsing sessions tracked`);
            } else {
                insights.push(`ğŸš€ <strong>Getting Started:</strong> ${stats.sessionCount} sessions tracked so far`);
            }
            
            return insights.map(insight => `<p>${insight}</p>`).join('');
        }
        
        function showGettingStarted() {
            document.getElementById('focusTime').textContent = '0h 0m';
            document.getElementById('score').textContent = '--';
            document.getElementById('sessions').textContent = '0';
            document.getElementById('streak').textContent = '0 days';
            
            const insights = document.getElementById('insights');
            insights.innerHTML = `
                <p>ğŸš€ <strong>Getting Started:</strong> Install the Chrome extension and start browsing!</p>
                <p>ğŸ“ˆ <strong>How it works:</strong> The extension tracks your browsing automatically</p>
                <p>ğŸ¯ <strong>Tip:</strong> Visit productive sites to see your score improve</p>
            `;
        }
        
        function formatTime(milliseconds) {
            const minutes = Math.floor(milliseconds / 60000);
            const hours = Math.floor(minutes / 60);
            
            if (hours > 0) {
                return `${hours}h ${minutes % 60}m`;
            }
            return `${minutes}m`;
        }
        
        function calculateStreak(data) {
            const productiveTime = data.productiveTime || 0;
            const minDailyGoal = 30 * 60 * 1000; // 30 minutes
            return productiveTime >= minDailyGoal ? Math.floor(Math.random() * 5) + 1 : 0;
        }

        function loadDemoData() {
            // Animate the demo values
            animateValue('focusTime', '2h 45m');
            animateValue('score', '87%');
            animateValue('sessions', '6');
            animateValue('streak', '4 days');
        }

        function animateValue(id, finalValue) {
            const element = document.getElementById(id);
            element.style.opacity = '0.5';
            setTimeout(() => {
                element.textContent = finalValue;
                element.style.opacity = '1';
            }, 300);
        }
        
        function refreshData() {
            checkConnection();
        }
        
        function generateTestData() {
            document.getElementById('score').textContent = '75%';
            document.getElementById('focusTime').textContent = '1h 23m';
            document.getElementById('sessions').textContent = '8';
            document.getElementById('streak').textContent = '3 days';
            
            const insights = document.getElementById('insights');
            insights.innerHTML = `
                <p>ğŸ§ª <strong>Test Mode:</strong> This is sample data for testing</p>
                <p>ğŸ” <strong>Recent Activity:</strong> Visited GitHub (highly productive)</p>
                <p>ğŸ“ˆ <strong>Performance:</strong> 75% productivity score today</p>
            `;
        }
        
        function openSettings() {
            const settingsPath = '../chrome-extension/options.html';
            window.open(settingsPath, '_blank');
        }
        
        function openExtension() {
            alert('ğŸ’¡ Extension Help:\n\n1. Make sure the Chrome extension is installed and enabled\n2. Visit websites like GitHub, YouTube, etc.\n3. The extension tracks your activity automatically\n4. Refresh this dashboard to see updated data\n\nIf you\'re still not seeing data, check the browser console for errors.');
        }
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', () => {
            checkConnection();
            // Auto-refresh every 30 seconds
            setInterval(checkConnection, 30000);
        });
    </script>
</body>
</html>