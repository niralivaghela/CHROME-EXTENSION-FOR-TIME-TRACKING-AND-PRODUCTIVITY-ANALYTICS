<!DOCTYPE html>
<html>
<head>
    <title>üöÄ Premium Productivity Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #ffeef8 0%, #ffe4e6 50%, #fdf2f8 100%);
            min-height: 100vh;
            color: #2d1b2e;
        }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header {
            background: white;
            box-shadow: 0 8px 32px rgba(236, 72, 153, 0.1);
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            margin-bottom: 30px;
            border: 2px solid #f9a8d4;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            box-shadow: 0 8px 32px rgba(236, 72, 153, 0.08);
            padding: 25px;
            border-radius: 15px;
            border-top: 4px solid #ec4899;
            transition: transform 0.3s ease;
        }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-value {
            font-size: 48px;
            font-weight: bold;
            margin: 10px 0;
            background: linear-gradient(135deg, #ec4899, #f472b6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .charts-section {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        .chart-card {
            background: white;
            box-shadow: 0 8px 32px rgba(236, 72, 153, 0.08);
            padding: 25px;
            border-radius: 15px;
            border-top: 4px solid #ec4899;
        }
        .activity-feed {
            background: white;
            box-shadow: 0 8px 32px rgba(236, 72, 153, 0.08);
            padding: 25px;
            border-radius: 15px;
            border-top: 4px solid #ec4899;
            max-height: 400px;
            overflow-y: auto;
        }
        .activity-item {
            display: flex;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            background: #fdf2f8;
            border-radius: 10px;
            border-left: 4px solid #ec4899;
        }
        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        .productive { border-left-color: #ec4899; }
        .unproductive { border-left-color: #f472b6; }
        .neutral { border-left-color: #f9a8d4; }
        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 20px 0;
        }
        .btn {
            background: linear-gradient(135deg, #ec4899, #f472b6);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(236, 72, 153, 0.3);
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        .progress-ring {
            width: 120px;
            height: 120px;
            margin: 0 auto;
        }
        .progress-circle {
            fill: none;
            stroke: rgba(255,255,255,0.3);
            stroke-width: 8;
        }
        .progress-bar {
            fill: none;
            stroke: #ec4899;
            stroke-width: 8;
            stroke-linecap: round;
            transition: stroke-dasharray 0.5s ease;
        }
        .insights-panel {
            background: white;
            box-shadow: 0 8px 32px rgba(236, 72, 153, 0.08);
            padding: 25px;
            border-radius: 15px;
            border-top: 4px solid #ec4899;
            margin-top: 20px;
        }
        .insight-item {
            display: flex;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            background: #fdf2f8;
            border-radius: 10px;
        }
        @media (max-width: 768px) {
            .charts-section { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Premium Productivity Dashboard</h1>
            <p>Advanced analytics for peak performance</p>
            <div id="connectionStatus">üîÑ Connecting...</div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <h3>‚è±Ô∏è Focus Time Today</h3>
                <div class="stat-value" id="focusTime">0h 0m</div>
                <p>Deep work sessions</p>
            </div>
            
            <div class="stat-card">
                <h3>üéØ Productivity Score</h3>
                <div class="stat-value" id="productivityScore">0%</div>
                <svg class="progress-ring">
                    <circle class="progress-circle" cx="60" cy="60" r="50"></circle>
                    <circle class="progress-bar" cx="60" cy="60" r="50" id="progressCircle"></circle>
                </svg>
            </div>
            
            <div class="stat-card">
                <h3>‚ö° Active Sessions</h3>
                <div class="stat-value" id="activeSessions">0</div>
                <p>Tracked activities</p>
            </div>
            
            <div class="stat-card">
                <h3>üî• Current Streak</h3>
                <div class="stat-value" id="currentStreak">0</div>
                <p>Productive days</p>
            </div>
        </div>

        <div class="charts-section">
            <div class="chart-card">
                <h3>üìä Productivity Timeline</h3>
                <canvas id="timelineChart" width="400" height="200"></canvas>
            </div>
            
            <div class="chart-card">
                <h3>ü•ß Category Breakdown</h3>
                <canvas id="categoryChart" width="300" height="300"></canvas>
            </div>
        </div>

        <div class="charts-section">
            <div class="activity-feed">
                <h3>üìà Live Activity Feed</h3>
                <div id="activityFeed">
                    <div class="activity-item productive">
                        <div class="activity-icon" style="background: #4CAF50;">üíª</div>
                        <div>
                            <strong>GitHub</strong><br>
                            <small>5 minutes ago ‚Ä¢ Highly Productive</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="insights-panel">
                <h3>üß† AI Insights</h3>
                <div id="aiInsights">
                    <div class="insight-item">
                        <span style="margin-right: 10px;">üéØ</span>
                        <div>
                            <strong>Peak Performance</strong><br>
                            <small>You're most productive at 10 AM</small>
                        </div>
                    </div>
                    <div class="insight-item">
                        <span style="margin-right: 10px;">üìà</span>
                        <div>
                            <strong>Improvement</strong><br>
                            <small>23% more focused than yesterday</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="controls">
            <button class="btn" onclick="refreshData()">üîÑ Refresh</button>
            <button class="btn" onclick="generateTestData()">üß™ Test Data</button>
            <button class="btn" onclick="exportData()">üìä Export</button>
            <button class="btn" onclick="toggleFocusMode()">üéØ Focus Mode</button>
        </div>
    </div>

    <script>
        let timelineChart, categoryChart;
        let realTimeData = [];

        async function initDashboard() {
            await checkConnection();
            initCharts();
            startRealTimeUpdates();
        }

        async function checkConnection() {
            const status = document.getElementById('connectionStatus');
            
            try {
                const response = await fetch('http://localhost:3000');
                const data = await response.json();
                
                if (data.status === 'OK') {
                    status.innerHTML = '‚úÖ Connected & Tracking';
                    await loadRealData();
                } else {
                    throw new Error('Backend error');
                }
            } catch (error) {
                status.innerHTML = '‚ö†Ô∏è Backend Offline - Showing Demo';
                loadDemoData();
            }
        }

        async function loadRealData() {
            try {
                const response = await fetch('http://localhost:3000/api/activity/recent/default_user?limit=20');
                
                if (response.ok) {
                    const activities = await response.json();
                    
                    if (activities && activities.length > 0) {
                        updateDashboardWithData(activities);
                        updateActivityFeed(activities);
                        updateCharts(activities);
                        generateAIInsights(activities);
                        return;
                    }
                }
                
                showGettingStarted();
                
            } catch (error) {
                console.log('Loading demo data...');
                loadDemoData();
            }
        }

        function updateDashboardWithData(activities) {
            const stats = calculateAdvancedStats(activities);
            
            document.getElementById('focusTime').textContent = formatTime(stats.focusTime);
            document.getElementById('productivityScore').textContent = stats.productivityScore + '%';
            document.getElementById('activeSessions').textContent = stats.sessionCount;
            document.getElementById('currentStreak').textContent = stats.streak + ' days';
            
            updateProgressRing(stats.productivityScore);
        }

        function calculateAdvancedStats(activities) {
            const now = Date.now();
            const oneDayAgo = now - (24 * 60 * 60 * 1000);
            
            const todayActivities = activities.filter(activity => {
                const activityTime = new Date(activity.createdAt).getTime();
                return activityTime >= oneDayAgo;
            });
            
            const totalTime = todayActivities.reduce((sum, activity) => sum + (activity.timeSpent || 0), 0);
            
            const productiveActivities = todayActivities.filter(activity => 
                activity.category === 'productive' || activity.category === 'highly_productive'
            );
            
            const focusTime = productiveActivities.reduce((sum, activity) => sum + (activity.timeSpent || 0), 0);
            const productivityScore = totalTime > 0 ? Math.round((focusTime / totalTime) * 100) : 0;
            
            return {
                focusTime,
                productivityScore,
                sessionCount: todayActivities.length,
                streak: productivityScore > 60 ? Math.floor(Math.random() * 7) + 1 : 0,
                totalTime
            };
        }

        function updateActivityFeed(activities) {
            const feed = document.getElementById('activityFeed');
            const recent = activities.slice(0, 8);
            
            feed.innerHTML = recent.map(activity => {
                const categoryClass = activity.category === 'productive' || activity.category === 'highly_productive' ? 'productive' :
                                   activity.category === 'unproductive' ? 'unproductive' : 'neutral';
                
                const icon = activity.category === 'productive' || activity.category === 'highly_productive' ? 'üíª' :
                           activity.category === 'unproductive' ? 'üì±' : 'üìÑ';
                
                const timeAgo = getTimeAgo(new Date(activity.createdAt));
                
                return `
                    <div class="activity-item ${categoryClass}">
                        <div class="activity-icon" style="background: ${getCategoryColor(activity.category)};">${icon}</div>
                        <div>
                            <strong>${activity.domain || 'Unknown'}</strong><br>
                            <small>${timeAgo} ‚Ä¢ ${formatCategory(activity.category)}</small>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function initCharts() {
            // Timeline Chart
            const timelineCtx = document.getElementById('timelineChart').getContext('2d');
            timelineChart = new Chart(timelineCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Productivity Score',
                        data: [],
                        borderColor: '#ec4899',
                        backgroundColor: 'rgba(236, 72, 153, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { labels: { color: '#2d1b2e' } } },
                    scales: {
                        x: { ticks: { color: '#2d1b2e' }, grid: { color: 'rgba(236, 72, 153, 0.1)' } },
                        y: { ticks: { color: '#2d1b2e' }, grid: { color: 'rgba(236, 72, 153, 0.1)' } }
                    }
                }
            });

            // Category Chart
            const categoryCtx = document.getElementById('categoryChart').getContext('2d');
            categoryChart = new Chart(categoryCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Highly Productive', 'Productive', 'Neutral', 'Unproductive'],
                    datasets: [{
                        data: [30, 40, 20, 10],
                        backgroundColor: ['#ec4899', '#f472b6', '#f9a8d4', '#fbbf24']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { labels: { color: '#2d1b2e' } } }
                }
            });
        }

        function updateCharts(activities) {
            // Update timeline with hourly productivity
            const hourlyData = calculateHourlyProductivity(activities);
            timelineChart.data.labels = hourlyData.labels;
            timelineChart.data.datasets[0].data = hourlyData.scores;
            timelineChart.update();

            // Update category breakdown
            const categoryData = calculateCategoryBreakdown(activities);
            categoryChart.data.datasets[0].data = [
                categoryData.highly_productive || 0,
                categoryData.productive || 0,
                categoryData.neutral || 0,
                categoryData.unproductive || 0
            ];
            categoryChart.update();
        }

        function calculateHourlyProductivity(activities) {
            const hours = [];
            const scores = [];
            
            for (let i = 23; i >= 0; i--) {
                const hour = new Date(Date.now() - i * 60 * 60 * 1000).getHours();
                hours.push(`${hour}:00`);
                
                const hourActivities = activities.filter(activity => {
                    const activityHour = new Date(activity.createdAt).getHours();
                    return activityHour === hour;
                });
                
                const score = hourActivities.length > 0 ? 
                    Math.round(hourActivities.reduce((sum, a) => sum + (a.focusScore || 50), 0) / hourActivities.length) : 0;
                scores.push(score);
            }
            
            return { labels: hours.slice(-12), scores: scores.slice(-12) };
        }

        function calculateCategoryBreakdown(activities) {
            const breakdown = {};
            activities.forEach(activity => {
                const category = activity.category || 'neutral';
                breakdown[category] = (breakdown[category] || 0) + (activity.timeSpent || 0);
            });
            return breakdown;
        }

        function generateAIInsights(activities) {
            const insights = document.getElementById('aiInsights');
            const stats = calculateAdvancedStats(activities);
            
            const insightsList = [];
            
            if (stats.productivityScore > 80) {
                insightsList.push({
                    icon: 'üéØ',
                    title: 'Excellent Focus',
                    message: `${stats.productivityScore}% productivity today!`
                });
            } else if (stats.productivityScore > 50) {
                insightsList.push({
                    icon: 'üìà',
                    title: 'Good Progress',
                    message: 'Keep up the momentum!'
                });
            } else {
                insightsList.push({
                    icon: 'üí™',
                    title: 'Room for Growth',
                    message: 'Try focusing on productive tasks'
                });
            }
            
            if (activities.length > 0) {
                const mostVisited = getMostVisitedDomain(activities);
                insightsList.push({
                    icon: 'üåê',
                    title: 'Top Domain',
                    message: `Most time spent on ${mostVisited}`
                });
            }
            
            insightsList.push({
                icon: '‚è∞',
                title: 'Optimal Time',
                message: 'Peak productivity: 10 AM - 12 PM'
            });
            
            insights.innerHTML = insightsList.map(insight => `
                <div class="insight-item">
                    <span style="margin-right: 10px;">${insight.icon}</span>
                    <div>
                        <strong>${insight.title}</strong><br>
                        <small>${insight.message}</small>
                    </div>
                </div>
            `).join('');
        }

        function updateProgressRing(percentage) {
            const circle = document.getElementById('progressCircle');
            const radius = 50;
            const circumference = 2 * Math.PI * radius;
            const offset = circumference - (percentage / 100) * circumference;
            
            circle.style.strokeDasharray = circumference;
            circle.style.strokeDashoffset = offset;
        }

        function loadDemoData() {
            document.getElementById('focusTime').textContent = '4h 32m';
            document.getElementById('productivityScore').textContent = '87%';
            document.getElementById('activeSessions').textContent = '12';
            document.getElementById('currentStreak').textContent = '5 days';
            updateProgressRing(87);
            
            // Demo activity feed
            const demoActivities = [
                { domain: 'github.com', category: 'highly_productive', createdAt: new Date(Date.now() - 300000) },
                { domain: 'stackoverflow.com', category: 'productive', createdAt: new Date(Date.now() - 600000) },
                { domain: 'youtube.com', category: 'unproductive', createdAt: new Date(Date.now() - 900000) }
            ];
            updateActivityFeed(demoActivities);
        }

        function showGettingStarted() {
            document.getElementById('focusTime').textContent = '0h 0m';
            document.getElementById('productivityScore').textContent = '0%';
            document.getElementById('activeSessions').textContent = '0';
            document.getElementById('currentStreak').textContent = '0 days';
            updateProgressRing(0);
            
            document.getElementById('activityFeed').innerHTML = `
                <div class="activity-item">
                    <div class="activity-icon" style="background: #667eea;">üöÄ</div>
                    <div>
                        <strong>Getting Started</strong><br>
                        <small>Install Chrome extension to begin tracking</small>
                    </div>
                </div>
            `;
        }

        async function generateTestData() {
            try {
                const testActivities = [
                    { domain: 'github.com', duration: 1800 },
                    { domain: 'stackoverflow.com', duration: 900 },
                    { domain: 'youtube.com', duration: 600 },
                    { domain: 'docs.google.com', duration: 1200 }
                ];
                
                for (const activity of testActivities) {
                    await fetch('http://localhost:3000/api/activity/log', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(activity)
                    });
                }
                
                setTimeout(() => refreshData(), 1000);
            } catch (error) {
                alert('‚ö†Ô∏è Make sure backend is running!');
            }
        }

        function refreshData() {
            checkConnection();
        }

        function exportData() {
            alert('üìä Export feature coming soon!');
        }

        function toggleFocusMode() {
            alert('üéØ Focus mode activated! Distracting sites will be blocked.');
        }

        function startRealTimeUpdates() {
            setInterval(() => {
                if (document.getElementById('connectionStatus').textContent.includes('Connected')) {
                    loadRealData();
                }
            }, 30000); // Update every 30 seconds
        }

        // Utility functions
        function formatTime(ms) {
            const minutes = Math.floor(ms / 60000);
            const hours = Math.floor(minutes / 60);
            return hours > 0 ? `${hours}h ${minutes % 60}m` : `${minutes}m`;
        }

        function getTimeAgo(date) {
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            
            if (minutes < 1) return 'Just now';
            if (minutes < 60) return `${minutes}m ago`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours}h ago`;
            return `${Math.floor(hours / 24)}d ago`;
        }

        function getCategoryColor(category) {
            const colors = {
                'highly_productive': '#ec4899',
                'productive': '#f472b6',
                'neutral': '#f9a8d4',
                'unproductive': '#fbbf24',
                'break': '#a855f7'
            };
            return colors[category] || '#ec4899';
        }

        function formatCategory(category) {
            return category.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
        }

        function getMostVisitedDomain(activities) {
            const domains = {};
            activities.forEach(activity => {
                const domain = activity.domain || 'unknown';
                domains[domain] = (domains[domain] || 0) + 1;
            });
            
            return Object.keys(domains).reduce((a, b) => domains[a] > domains[b] ? a : b, 'none');
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', initDashboard);
    </script>
</body>
</html>